<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои заказы - Название</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .orders-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            color: #333;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f1f5f9;
            color: #475569;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }

            .back-button:hover {
                background: #e2e8f0;
                transform: translateY(-2px);
            }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 4px solid #667eea;
        }

            .order-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .order-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }

        .order-id {
            color: #667eea;
            font-weight: 600;
        }

        .order-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #718096;
        }

        .order-description {
            color: #4a5568;
            line-height: 1.5;
            margin-bottom: 15px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .order-date {
            color: #6b7280;
            font-size: 12px;
        }

        .order-cost {
            font-weight: 600;
            color: #059669;
        }

            .order-cost:before {
                content: "₽ ";
            }

        .order-actions {
            display: flex;
            gap: 10px;
        }

        .order-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

            .order-action-btn.view {
                background: #667eea;
                color: white;
            }

            .order-action-btn.support {
                background: #f1f5f9;
                color: #475569;
            }

            .order-action-btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

            .empty-state i {
                font-size: 48px;
                margin-bottom: 20px;
                color: #9ca3af;
            }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            color: #4b5563;
        }

            .filter-btn.active {
                background: #667eea;
                color: white;
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        /* Модальное окно */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

            .modal-overlay.active {
                display: flex;
            }

        .modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

            .close-modal:hover {
                background: #f1f5f9;
            }

        .modal-content {
            padding: 20px;
        }

        .info-section {
            margin-bottom: 25px;
        }

            .info-section h4 {
                font-size: 16px;
                color: #475569;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .info-label {
            font-weight: 600;
            color: #64748b;
            min-width: 150px;
        }

        .info-value {
            color: #334155;
        }

        .manager-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #0ea5e9;
        }

        .report-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.3s;
        }

            .report-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .report-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .report-date {
            color: #64748b;
            font-size: 12px;
        }

        .report-content {
            color: #475569;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 100px;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .report-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }

        .no-reports {
            text-align: center;
            padding: 30px;
            color: #94a3b8;
        }

            .no-reports i {
                font-size: 36px;
                margin-bottom: 10px;
                display: block;
            }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .orders-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                justify-content: center;
            }

            .order-footer {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .order-actions {
                align-self: flex-end;
            }

            .modal {
                max-width: 95%;
            }

            .info-row {
                flex-direction: column;
                gap: 5px;
            }

            .info-label {
                min-width: auto;
            }
        }
        /* Стили для кнопки "Показать полностью" */
        .btn-show-more {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }

            .btn-show-more:hover {
                background: #f1f5f9;
            }

        .report-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .report-author {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }

        .author-name {
            font-weight: 500;
        }

        .author-email {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Стили для полного отчета */
        .full-report-content {
            line-height: 1.6;
            color: #334155;
            white-space: pre-wrap;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-top: 10px;
        }

            .full-report-content br {
                margin-bottom: 8px;
                display: block;
                content: "";
            }

        /* Улучшенные стили для отчетов */
        .report-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

            .report-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                border-color: #cbd5e1;
            }

            .report-card::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: #667eea;
                border-radius: 4px 0 0 4px;
            }

        .report-content {
            color: #475569;
            line-height: 1.5;
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 4px;
            font-size: 14px;
            max-height: 100px;
            overflow: hidden;
            transition: max-height 0.3s;
        }

            .report-content.expanded {
                max-height: none;
                overflow-y: auto;
            }

        .no-reports {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }

            .no-reports i {
                font-size: 36px;
                margin-bottom: 10px;
                display: block;
                color: #cbd5e1;
            }

            .no-reports p {
                font-size: 16px;
                margin-bottom: 5px;
                color: #64748b;
            }

            .no-reports small {
                font-size: 12px;
                color: #94a3b8;
            }
    </style>
</head>
<body class="dashboard-page">
    <div class="container">
        <header class="dashboard-header">
            <h1 class="dashboard-title">
                <a href="index.html" style="color: #667eea; text-decoration: none;">Название</a>
            </h1>
            <div class="user-info">
                <span id="userName">Загрузка...</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </button>
            </div>
        </header>

        <div class="orders-container">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="bi bi-list-check"></i> Мои заказы
                </h1>
                <a href="user-dashboard.html" class="back-button">
                    <i class="bi bi-arrow-left"></i> Назад в панель
                </a>
            </div>

            <!-- Фильтры -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterOrders('all')">Все</button>
                <button class="filter-btn" onclick="filterOrders('new')">Новые</button>
                <button class="filter-btn" onclick="filterOrders('processing')">В обработке</button>
                <button class="filter-btn" onclick="filterOrders('completed')">Завершенные</button>
                <button class="filter-btn" onclick="filterOrders('cancelled')">Отмененные</button>
            </div>

            <!-- Контейнер для заказов -->
            <div id="ordersContainer" class="orders-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Загрузка заказов...
                </div>
            </div>

            <!-- Статистика -->
            <div id="statsContainer" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 15px; color: #333;">Статистика заказов</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="padding: 15px; background: #f8fafc; border-radius: 8px; min-width: 150px;">
                            <div style="font-size: 12px; color: #64748b;">Всего заказов</div>
                            <div style="font-size: 24px; font-weight: 600; color: #667eea;" id="totalOrders">0</div>
                        </div>
                        <div style="padding: 15px; background: #dbeafe; border-radius: 8px; min-width: 150px;">
                            <div style="font-size: 12px; color: #1e40af;">Новые</div>
                            <div style="font-size: 24px; font-weight: 600; color: #1e40af;" id="newOrders">0</div>
                        </div>
                        <div style="padding: 15px; background: #fef3c7; border-radius: 8px; min-width: 150px;">
                            <div style="font-size: 12px; color: #92400e;">В обработке</div>
                            <div style="font-size: 24px; font-weight: 600; color: #92400e;" id="processingOrders">0</div>
                        </div>
                        <div style="padding: 15px; background: #d1fae5; border-radius: 8px; min-width: 150px;">
                            <div style="font-size: 12px; color: #065f46;">Завершенные</div>
                            <div style="font-size: 24px; font-weight: 600; color: #065f46;" id="completedOrders">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="dashboard-footer">
            <p>© 2024 Support System. Мои заказы</p>
        </footer>
    </div>

    <!-- Модальное окно деталей заказа -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="bi bi-info-circle"></i>
                    <span id="modalOrderTitle">Заказ #</span>
                </h3>
                <button class="close-modal" onclick="closeModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-content">
                <!-- Основная информация о заказе -->
                <div class="info-section">
                    <h4><i class="bi bi-card-text"></i> Информация о заказе</h4>
                    <div class="info-row">
                        <span class="info-label">Название:</span>
                        <span class="info-value" id="modalOrderName"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Статус:</span>
                        <span class="info-value" id="modalOrderStatus"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Приоритет:</span>
                        <span class="info-value" id="modalOrderPriority"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Дата создания:</span>
                        <span class="info-value" id="modalCreateDate"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Дата завершения:</span>
                        <span class="info-value" id="modalCompleteDate"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Стоимость:</span>
                        <span class="info-value" id="modalCost"></span>
                    </div>
                </div>

                <!-- Информация о менеджере -->
                <div class="info-section">
                    <h4><i class="bi bi-person-badge"></i> Ответственный менеджер</h4>
                    <div id="managerInfo">
                        <div class="no-reports">
                            <i class="bi bi-person-x"></i>
                            <p>Менеджер не назначен</p>
                        </div>
                    </div>
                </div>

                <!-- Отчеты по заказу -->
                <div class="info-section">
                    <h4><i class="bi bi-file-text"></i> Отчеты по заказу</h4>
                    <div id="reportsList">
                        <div class="no-reports">
                            <i class="bi bi-file-earmark"></i>
                            <p>Отчетов пока нет</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification" style="display: none;"></div>

    <script>
        const API_URL = 'https://localhost:7100';
        let currentUser = null;
        let allOrders = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', function () {
            initializeOrdersPage();
        });

        async function initializeOrdersPage() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await loadUserInfo();
                await loadOrders();
                setupEventListeners();
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            if (!token || !userJson) {
                showNotification('Требуется авторизация', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }

            try {
                currentUser = JSON.parse(userJson);

                if (currentUser.role !== 'User') {
                    redirectByRole(currentUser.role);
                    return false;
                }

                const response = await fetch(`${API_URL}/api/Auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.clear();
                    showNotification('Сессия истекла', 'error');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.clear();
                showNotification('Ошибка авторизации', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }
        }

        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('userName').textContent = userData.name || userData.email || 'Пользователь';
                } else {
                    document.getElementById('userName').textContent = currentUser.name || currentUser.email || 'Пользователь';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('userName').textContent = currentUser.name || currentUser.email || 'Пользователь';
            }
        }

        async function loadOrders() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Orders/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allOrders = await response.json();
                    displayOrders();
                    updateStats();
                } else {
                    showNotification('Ошибка загрузки заказов', 'error');
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification('Ошибка соединения с сервером', 'error');
                showEmptyState();
            }
        }

        function displayOrders() {
            const container = document.getElementById('ordersContainer');

            if (!allOrders || allOrders.length === 0) {
                showEmptyState();
                return;
            }

            const filteredOrders = filterOrdersByStatus(currentFilter);

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h3>Нет заказов с выбранным статусом</h3>
                                <p>Попробуйте выбрать другой фильтр</p>
                            </div>
                        `;
                return;
            }

            const ordersHtml = filteredOrders.map(order => createOrderCard(order)).join('');
            container.innerHTML = ordersHtml;
        }

        function filterOrdersByStatus(status) {
            if (status === 'all') return allOrders;

            return allOrders.filter(order => {
                const orderStatus = order.status.toLowerCase();
                return orderStatus === status.toLowerCase();
            });
        }

        function filterOrders(status) {
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            currentFilter = status;
            displayOrders();
        }

        function createOrderCard(order) {
            const status = order.status.toLowerCase();
            const statusText = getStatusText(order.status);
            const statusClass = `status-${status}`;

            const description = order.description.length > 150
                ? order.description.substring(0, 150) + '...'
                : order.description;

            // ТОЛЬКО ДАТА (без времени)
            const date = new Date(order.createDate).toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            // Показываем кнопку "Подробнее" только для НЕ новых заказов
            const showDetailsButton = status !== 'new';
            const detailsButtonHtml = showDetailsButton
                ? `<button class="order-action-btn view" onclick="viewOrderDetails(${order.id})">
                                <i class="bi bi-eye"></i> Подробнее
                           </button>`
                : '';

            return `
                        <div class="order-card">
                            <div class="order-header">
                                <h3 class="order-title">${order.orderName}</h3>
                                <span class="order-id">#${order.id}</span>
                            </div>

                            <div class="order-meta">
                                <div class="order-date">
                                    <i class="bi bi-calendar"></i> ${date}
                                </div>
                                ${order.cost ? `<div class="order-cost">${order.cost}</div>` : ''}
                            </div>

                            <div class="order-description">
                                ${description}
                            </div>

                            <div class="order-footer">
                                <div class="status-badge ${statusClass}">
                                    ${statusText}
                                </div>

                                <div class="order-actions">
                                    ${detailsButtonHtml}
                                    <a href="support.html?orderId=${order.id}" class="order-action-btn support">
                                        <i class="bi bi-headset"></i> Поддержка
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'Новый',
                'processing': 'В обработке',
                'completed': 'Завершен',
                'cancelled': 'Отменен'
            };

            const key = status.toLowerCase();
            return statusMap[key] || status;
        }

        async function viewOrderDetails(orderId) {
            try {
                const token = localStorage.getItem('token');

                // Получаем детальную информацию о заказе
                const response = await fetch(`${API_URL}/api/Orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const order = await response.json();

                    // Обновляем информацию в модальном окне
                    document.getElementById('modalOrderTitle').textContent = `Заказ #${order.id}`;
                    document.getElementById('modalOrderName').textContent = order.orderName;
                    document.getElementById('modalOrderStatus').textContent = getStatusText(order.status);
                    document.getElementById('modalOrderPriority').textContent = order.priority;

                    // ТОЛЬКО ДАТА создания (без времени)
                    const createDate = new Date(order.createDate);
                    document.getElementById('modalCreateDate').textContent =
                        createDate.toLocaleDateString('ru-RU');

                    // ТОЛЬКО ДАТА завершения (без времени)
                    if (order.completeDate) {
                        const completeDate = new Date(order.completeDate);
                        document.getElementById('modalCompleteDate').textContent =
                            completeDate.toLocaleDateString('ru-RU');
                    } else {
                        document.getElementById('modalCompleteDate').textContent = 'Не завершен';
                    }

                    document.getElementById('modalCost').textContent = order.cost ? `${order.cost} ₽` : 'Не указана';

                    // Отображаем информацию о менеджере
                    const managerInfo = document.getElementById('managerInfo');
                    if (order.assignedToId && order.managerName && order.managerName !== "Не назначен") {
                        managerInfo.innerHTML = `
                                    <div class="manager-info">
                                        <div class="info-row">
                                            <span class="info-label">Имя:</span>
                                            <span class="info-value">${order.managerName}</span>
                                        </div>
                                        ${order.managerEmail ? `
                                        <div class="info-row">
                                            <span class="info-label">Email:</span>
                                            <span class="info-value">${order.managerEmail}</span>
                                        </div>
                                        ` : ''}
                                        ${order.managerPhone ? `
                                        <div class="info-row">
                                            <span class="info-label">Телефон:</span>
                                            <span class="info-value">${order.managerPhone}</span>
                                        </div>
                                        ` : ''}
                                        ${order.managerRole ? `
                                        <div class="info-row">
                                            <span class="info-label">Роль:</span>
                                            <span class="info-value">${order.managerRole}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                    } else {
                        managerInfo.innerHTML = `
                                    <div class="no-reports">
                                        <i class="bi bi-person-x"></i>
                                        <p>Менеджер не назначен</p>
                                    </div>
                                `;
                    }

                    // Загружаем отчеты по этому заказу
                    await loadOrderReports(orderId);

                    // Показываем модальное окно
                    document.getElementById('orderModal').classList.add('active');
                } else {
                    showNotification('Не удалось загрузить информацию о заказе', 'error');
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                showNotification('Ошибка загрузки деталей заказа', 'error');
            }
        }

        async function loadOrderReports(orderId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Reports/order/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const reportsList = document.getElementById('reportsList');

                if (response.ok) {
                    const reports = await response.json();

                    if (reports && reports.length > 0) {
                        const reportsHtml = reports.map(report => {
                            // ТОЛЬКО ДАТА отчета (без времени)
                            const reportDate = new Date(report.createDate);
                            const formattedDate = reportDate.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });

                            // Обрезаем длинный контент для предпросмотра
                            const shortContent = report.content.length > 150
                                ? report.content.substring(0, 150) + '...'
                                : report.content;

                            return `
                            <div class="report-card">
                                <div class="report-header">
                                    <h4 class="report-title">${report.title}</h4>
                                    <span class="report-date">
                                        <i class="bi bi-calendar"></i> ${formattedDate}
                                    </span>
                                </div>
                                <div class="report-content">${shortContent}</div>
                                <div class="report-footer">
                                    <div class="report-author">
                                        <i class="bi bi-person-circle"></i>
                                        <span class="author-name">${report.authorName || 'Неизвестный автор'}</span>
                                        ${report.authorEmail ? `<span class="author-email">(${report.authorEmail})</span>` : ''}
                                    </div>
                                    ${report.content.length > 150 ? `
                                    <button class="btn-show-more" onclick="showFullReport(${report.id}, '${report.title.replace(/'/g, "\\'")}', \`${report.content.replace(/`/g, "\\`").replace(/\n/g, "<br>")}\`)">
                                        <i class="bi bi-arrows-angle-expand"></i> Показать полностью
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        }).join('');

                        reportsList.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #475569; margin-bottom: 10px;">
                                <i class="bi bi-file-text"></i> Отчеты по заказу (${reports.length})
                            </h5>
                        </div>
                        ${reportsHtml}
                    `;
                    } else {
                        reportsList.innerHTML = `
                        <div class="no-reports">
                            <i class="bi bi-file-earmark-excel"></i>
                            <p>Отчетов по этому заказу пока нет</p>
                            <small>Как только менеджер добавит отчет, он появится здесь</small>
                        </div>
                    `;
                    }
                } else if (response.status === 403) {
                    reportsList.innerHTML = `
                    <div class="no-reports">
                        <i class="bi bi-shield-lock"></i>
                        <p>Нет доступа к отчетам по этому заказу</p>
                    </div>
                `;
                } else if (response.status === 404) {
                    reportsList.innerHTML = `
                    <div class="no-reports">
                        <i class="bi bi-file-earmark"></i>
                        <p>Нет отчетов по этому заказу</p>
                    </div>
                `;
                } else {
                    reportsList.innerHTML = `
                    <div class="no-reports">
                        <i class="bi bi-exclamation-triangle"></i>
                        <p>Не удалось загрузить отчеты</p>
                        <small>Попробуйте обновить страницу</small>
                    </div>
                `;
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reportsList').innerHTML = `
                <div class="no-reports">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>Ошибка загрузки отчетов</p>
                    <small>${error.message}</small>
                </div>
            `;
            }
        }

        // Функция для показа полного отчета
        function showFullReport(reportId, title, content) {
            // Создаем модальное окно для полного отчета
            const modalHtml = `
            <div id="reportModal" class="modal-overlay active">
                <div class="modal" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="bi bi-file-text"></i>
                            ${title}
                        </h3>
                        <button class="close-modal" onclick="closeReportModal()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="full-report-content">
                            ${content}
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Добавляем модальное окно в body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Настраиваем закрытие по клику на оверлей и Escape
            const modal = document.getElementById('reportModal');
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeReportModal();
                }
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeReportModal();
                }
            });
        }

        // Функция закрытия модального окна отчета
        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.style.display = 'block';

            const total = allOrders.length;
            const newCount = allOrders.filter(o => o.status.toLowerCase() === 'new').length;
            const processingCount = allOrders.filter(o => o.status.toLowerCase() === 'processing').length;
            const completedCount = allOrders.filter(o => o.status.toLowerCase() === 'completed').length;

            document.getElementById('totalOrders').textContent = total;
            document.getElementById('newOrders').textContent = newCount;
            document.getElementById('processingOrders').textContent = processingCount;
            document.getElementById('completedOrders').textContent = completedCount;
        }

        function showEmptyState() {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-cart"></i>
                            <h3>У вас пока нет заказов</h3>
                            <p>Создайте свой первый заказ, чтобы начать работу</p>
                            <a href="create-order.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 8px;">
                                <i class="bi bi-plus-circle"></i> Создать заказ
                            </a>
                        </div>
                    `;

            document.getElementById('statsContainer').style.display = 'none';
        }

        function setupEventListeners() {
            // Добавляем обновление заказов каждые 30 секунд
            setInterval(loadOrders, 30000);

            // Закрытие модального окна при клике на оверлей
            document.getElementById('orderModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Закрытие модального окна при нажатии Escape
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && document.getElementById('orderModal').classList.contains('active')) {
                    closeModal();
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;

            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, type === 'error' ? 5000 : 3000);

            notification.onclick = () => {
                notification.style.display = 'none';
            };
        }

        function redirectByRole(role) {
            const dashboards = {
                'Admin': 'admin-dashboard.html',
                'Manager': 'manager-dashboard.html',
                'User': 'user-dashboard.html'
            };
            window.location.href = dashboards[role] || 'login.html';
        }

        window.logout = function () {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        };

        // Экспортируем функции для использования в onclick
        window.filterOrders = filterOrders;
        window.viewOrderDetails = viewOrderDetails;
        window.closeModal = closeModal;
    </script>
</body>
</html>
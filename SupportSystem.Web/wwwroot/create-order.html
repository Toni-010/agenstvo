<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создание заказа - Support System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="dashboard-page">
    <div class="container">
        <header class="dashboard-header">
            <h1 class="dashboard-title">
                <a href="/user-dashboard.html" style="color: #667eea; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-arrow-left"></i> Support System
                </a>
            </h1>
            <div class="user-info">
                <span id="userName">Загрузка...</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </button>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="page-header">
                <h1><i class="bi bi-plus-circle"></i> Новый заказ</h1>
                <p class="page-subtitle">Заполните форму для создания заказа</p>
            </div>

            <div class="form-container">
                <form id="createOrderForm" class="order-form">
                    <div class="form-section">
                        <h3><i class="bi bi-card-heading"></i> Основная информация</h3>

                        <div class="form-group">
                            <label for="orderName" class="form-label">
                                Название заказа <span class="required-star">*</span>
                            </label>
                            <input type="text" id="orderName" name="orderName" class="form-input"
                                   placeholder="Разработка веб-сайта" required maxlength="250">
                            <div class="error-message" id="orderNameError"></div>
                            <div class="form-hint">Кратко опишите суть заказа</div>
                            <div class="char-counter" id="orderNameCounter">0/250</div>
                        </div>

                        <div class="form-group">
                            <label for="description" class="form-label">
                                Описание <span class="required-star">*</span>
                            </label>
                            <textarea id="description" name="description" class="form-input"
                                      rows="5" placeholder="Опишите ваш заказ, требования, сроки..." required maxlength="3500"></textarea>
                            <div class="error-message" id="descriptionError"></div>
                            <div class="form-hint">Чем подробнее описание, тем лучше</div>
                            <div class="char-counter" id="descriptionCounter">0/3500</div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="bi bi-gear"></i> Детали</h3>

                        <div class="form-group">
                            <label for="cost" class="form-label">
                                Ориентировочная стоимость
                            </label>
                            <div class="cost-input-wrapper">
                                <input type="number" id="cost" name="cost" class="form-input"
                                       placeholder="0.00" step="0.01" min="0" max="99999999.99">
                            </div>
                            <div class="form-hint">Укажите предполагаемую стоимость в рублях</div>
                        </div>

                        <div class="form-group">
                            <label for="priority" class="form-label">
                                Приоритет <span class="required-star">*</span>
                            </label>
                            <select id="priority" name="priority" class="form-input" required>
                                <option value="">Выберите приоритет</option>
                                <option value="Low">Низкий - не срочно</option>
                                <option value="Medium" selected>Средний - стандартный срок</option>
                                <option value="High">Высокий - срочно</option>
                            </select>
                            <div class="form-hint">Выберите приоритет выполнения</div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="goBack()" class="btn-secondary">
                            <i class="bi bi-x-lg"></i> Отмена
                        </button>
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <i class="bi bi-check-lg"></i> Создать заказ
                        </button>
                    </div>

                    <div class="form-info">
                        <p>
                            <i class="bi bi-info-circle"></i> Поля, отмеченные <span class="required-star">*</span>, обязательны для заполнения
                        </p>
                    </div>
                </form>
            </div>

            <div class="info-card">
                <h3><i class="bi bi-info-circle"></i> Что будет дальше?</h3>
                <ol>
                    <li>Заказ создается со статусом "Новый"</li>
                    <li>В течение 24 часов будет назначен менеджер</li>
                    <li>Менеджер свяжется для уточнения деталей</li>
                    <li>Вы сможете отслеживать статус заказа</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Оверлей загрузки -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Создание заказа...</div>
    </div>

    <script>
        const API_URL = 'https://localhost:7100';
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', function () {
            initializePage();
        });

        async function initializePage() {
            await checkAuth();
            loadUserData();
            setupForm();
            setupCharacterCounters();
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            if (!token || !userJson) {
                showNotification('Необходима авторизация', 'error');
                setTimeout(() => window.location.href = '/login.html', 1500);
                return false;
            }

            try {
                const user = JSON.parse(userJson);
                if (user.role !== 'User') {
                    redirectByRole(user.role);
                    return false;
                }

                // ИСПРАВЛЕНО: Используем правильный endpoint для проверки авторизации
                const response = await fetch(`${API_URL}/api/Auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.clear();
                    showNotification('Сессия истекла', 'error');
                    setTimeout(() => window.location.href = '/login.html', 1500);
                    return false;
                }

                // Дополнительная проверка через Users/me
                try {
                    const userResponse = await fetch(`${API_URL}/api/Users/me`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        // Обновляем данные пользователя в localStorage
                        const storedUser = JSON.parse(userJson);
                        storedUser.name = userData.name || storedUser.name;
                        storedUser.email = userData.email || storedUser.email;
                        storedUser.phone = userData.phone || storedUser.phone;
                        localStorage.setItem('user', JSON.stringify(storedUser));
                    }
                } catch (userError) {
                    console.warn('Не удалось обновить данные пользователя:', userError);
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.clear();
                showNotification('Ошибка авторизации', 'error');
                setTimeout(() => window.location.href = '/login.html', 1500);
                return false;
            }
        }

        function loadUserData() {
            const userJson = localStorage.getItem('user');
            if (userJson) {
                try {
                    const user = JSON.parse(userJson);
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = user.name || user.email || 'Пользователь';
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        }

        function redirectByRole(role) {
            const dashboards = {
                'Admin': '/admin-dashboard.html',
                'Manager': '/manager-dashboard.html',
                'User': '/user-dashboard.html'
            };
            const target = dashboards[role];
            if (target) {
                window.location.href = target;
            } else {
                window.location.href = '/login.html';
            }
        }

        function setupForm() {
            const form = document.getElementById('createOrderForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await validateAndSubmit();
            });

            const inputs = form.querySelectorAll('.form-input');
            inputs.forEach(input => {
                input.addEventListener('blur', validateField);
                input.addEventListener('input', () => {
                    clearError(input.id);
                });
            });
        }

        function setupCharacterCounters() {
            const orderNameInput = document.getElementById('orderName');
            const descriptionInput = document.getElementById('description');

            orderNameInput.addEventListener('input', function () {
                updateCounter('orderNameCounter', this.value.length, 250);
            });

            descriptionInput.addEventListener('input', function () {
                updateCounter('descriptionCounter', this.value.length, 3500);
            });

            updateCounter('orderNameCounter', orderNameInput.value.length, 250);
            updateCounter('descriptionCounter', descriptionInput.value.length, 3500);
        }

        function updateCounter(elementId, currentLength, maxLength) {
            const counter = document.getElementById(elementId);
            if (counter) {
                counter.textContent = `${currentLength}/${maxLength}`;
                counter.style.color = currentLength > maxLength ? '#ef4444' :
                    currentLength > maxLength * 0.9 ? '#f59e0b' : '#64748b';
            }
        }

        function validateField(e) {
            const input = e.target;
            const value = input.value.trim();
            const fieldId = input.id;

            clearError(fieldId);

            switch (fieldId) {
                case 'orderName':
                    if (!value) {
                        showError(fieldId, 'Название заказа обязательно');
                        return false;
                    }
                    if (value.length > 250) {
                        showError(fieldId, 'Максимум 250 символов');
                        return false;
                    }
                    break;

                case 'description':
                    if (!value) {
                        showError(fieldId, 'Описание обязательно');
                        return false;
                    }
                    if (value.length > 3500) {
                        showError(fieldId, 'Максимум 3500 символов');
                        return false;
                    }
                    break;

                case 'priority':
                    if (!value) {
                        showError(fieldId, 'Выберите приоритет');
                        return false;
                    }
                    break;

                case 'cost':
                    if (value) {
                        const cost = parseFloat(value);
                        if (isNaN(cost) || cost < 0) {
                            showError(fieldId, 'Введите корректную сумму');
                            return false;
                        }
                        if (cost > 99999999.99) {
                            showError(fieldId, 'Сумма слишком большая');
                            return false;
                        }
                    }
                    break;
            }

            return true;
        }

        function showError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');

            if (input) {
                input.classList.add('error');
                input.classList.remove('success');
            }

            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearError(fieldId) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');

            if (input) {
                input.classList.remove('error');
                input.classList.remove('success');
            }

            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        async function validateAndSubmit() {
            if (isLoading) return;

            const form = document.getElementById('createOrderForm');
            const inputs = form.querySelectorAll('.form-input');
            let isValid = true;

            inputs.forEach(input => {
                const event = new Event('blur');
                input.dispatchEvent(event);
                if (input.classList.contains('error')) {
                    isValid = false;
                }
            });

            if (!isValid) {
                showNotification('Исправьте ошибки в форме', 'error');
                return;
            }

            const orderData = {
                orderName: document.getElementById('orderName').value.trim(),
                description: document.getElementById('description').value.trim(),
                priority: document.getElementById('priority').value,
                cost: document.getElementById('cost').value ?
                    parseFloat(document.getElementById('cost').value) : null
            };

            if (!orderData.orderName || !orderData.description || !orderData.priority) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            isLoading = true;
            showLoading(true);

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Отправка...';

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Токен не найден');
                }

                const response = await fetch(`${API_URL}/api/Orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    ['orderName', 'description', 'priority', 'cost'].forEach(fieldId => {
                        const input = document.getElementById(fieldId);
                        if (input && input.value.trim()) {
                            input.classList.add('success');
                        }
                    });

                    const orderId = result.orderId || result.data?.Id;
                    const message = result.message || 'Заказ успешно создан!';

                    showNotification(`${message} (№${orderId})`, 'success');

                    setTimeout(() => {
                        form.reset();
                        updateCounter('orderNameCounter', 0, 250);
                        updateCounter('descriptionCounter', 0, 3500);

                        setTimeout(() => {
                            window.location.href = '/user-dashboard.html';
                        }, 1000);
                    }, 2000);

                } else {
                    const errorMessage = result.message || 'Ошибка при создании заказа';
                    const errorDetails = result.error ? `: ${result.error}` : '';
                    showNotification(errorMessage + errorDetails, 'error');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            } finally {
                isLoading = false;
                showLoading(false);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> Создать заказ';
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;

            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, type === 'error' ? 5000 : 3000);

            notification.onclick = () => {
                notification.style.display = 'none';
            };
        }

        function goBack() {
            const form = document.getElementById('createOrderForm');
            const hasData = Array.from(form.elements).some(element =>
                (element.type === 'text' || element.type === 'textarea' || element.type === 'number') &&
                element.value.trim() !== ''
            );

            if (hasData && !confirm('Все несохраненные данные будут потеряны. Продолжить?')) {
                return;
            }
            window.location.href = '/user-dashboard.html';
        }

        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                localStorage.clear();
                window.location.href = '/login.html';
            }
        }

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                goBack();
            }
        });

        // Добавляем спиннер в CSS через JavaScript
        const style = document.createElement('style');
        style.textContent = `
            .loading-spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
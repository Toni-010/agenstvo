<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление поддержкой - Администратор</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Стили для управления поддержкой */
        .support-management-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .support-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .support-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #2196F3;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(33, 150, 243, 0.15);
            }

            .stat-card.new {
                border-left-color: #ff9800;
            }

            .stat-card.processing {
                border-left-color: #2196F3;
            }

            .stat-card.completed {
                border-left-color: #4CAF50;
            }

            .stat-card.cancelled {
                border-left-color: #f44336;
            }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .support-filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

            .filter-group label {
                display: block;
                margin-bottom: 5px;
                color: #666;
                font-size: 14px;
            }

            .filter-group select,
            .filter-group input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
            }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .support-requests-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .support-request-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #2196F3;
            transition: all 0.3s;
        }

            .support-request-card:hover {
                box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            }

            .support-request-card.new {
                border-left-color: #ff9800;
            }

            .support-request-card.processing {
                border-left-color: #2196F3;
            }

            .support-request-card.completed {
                border-left-color: #4CAF50;
            }

            .support-request-card.cancelled {
                border-left-color: #f44336;
            }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .request-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .request-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
        }

        .request-client {
            background: #e3f2fd;
            padding: 3px 10px;
            border-radius: 12px;
        }

        .request-status {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new {
            background: #fff3e0;
            color: #ff9800;
        }

        .status-processing {
            background: #e3f2fd;
            color: #2196F3;
        }

        .status-completed {
            background: #e8f5e9;
            color: #4CAF50;
        }

        .status-cancelled {
            background: #ffebee;
            color: #f44336;
        }

        .request-content {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-edit, .btn-delete, .btn-view, .btn-respond, .btn-assign {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

            .btn-edit:hover {
                background: #1976D2;
            }

        .btn-delete {
            background: #f44336;
            color: white;
        }

            .btn-delete:hover {
                background: #d32f2f;
            }

        .btn-view {
            background: #4CAF50;
            color: white;
        }

            .btn-view:hover {
                background: #388E3C;
            }

        .btn-respond {
            background: #FF9800;
            color: white;
        }

            .btn-respond:hover {
                background: #F57C00;
            }

        .btn-assign {
            background: #9C27B0;
            color: white;
        }

            .btn-assign:hover {
                background: #7B1FA2;
            }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Редактирование запроса */
        .edit-form {
            display: grid;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Ответы */
        .reports-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .reports-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #4CAF50;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-author {
            font-weight: 600;
            color: #333;
        }

        .report-date {
            font-size: 12px;
            color: #666;
        }

        .report-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        .no-reports {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

            .empty-state i {
                font-size: 48px;
                margin-bottom: 15px;
                color: #ddd;
            }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

            .page-btn:hover {
                background: #f5f5f5;
            }

            .page-btn.active {
                background: #2196F3;
                color: white;
                border-color: #2196F3;
            }

            .page-btn.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
    </style>
</head>
<body class="dashboard-page">
    <div class="container">
        <header class="dashboard-header">
            <h1 class="dashboard-title">
                <a href="admin-dashboard.html" style="color: #f44336; text-decoration: none;">Название</a>
            </h1>
            <div class="user-info">
                <span id="userName">Загрузка...</span>
                <button onclick="goToDashboard()" class="btn-logout" style="margin-right: 10px;">
                    <i class="bi bi-arrow-left"></i> Назад
                </button>
                <button onclick="logout()" class="btn-logout">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </button>
            </div>
        </header>

        <div class="dashboard-content support-management-container">
            <div class="support-header">
                <h1 style="color: #d32f2f;">
                    <i class="bi bi-headset"></i> Управление поддержкой
                </h1>
                <button onclick="refreshData()" class="btn-refresh">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
            </div>

            <!-- Статистика -->
            <div class="support-stats" id="supportStats">
                
            </div>

            <!-- Фильтры -->
            <div class="support-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Статус:</label>
                        <select id="filterStatus">
                            <option value="">Все статусы</option>
                            <option value="New">Новый</option>
                            <option value="Processing">В обработке</option>
                            <option value="Completed">Завершен</option>
                            <option value="Cancelled">Отменен</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Менеджер:</label>
                        <select id="filterManager">
                            <option value="">Все менеджеры</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Клиент:</label>
                        <input type="text" id="filterClient" placeholder="Имя клиента">
                    </div>
                </div>
                <div class="filter-actions">
                    <button onclick="applyFilters()" class="btn-edit">
                        <i class="bi bi-funnel"></i> Применить фильтры
                    </button>
                    <button onclick="clearFilters()" class="btn-view">
                        <i class="bi bi-x-circle"></i> Сбросить
                    </button>
                </div>
            </div>

            <!-- Список запросов поддержки -->
            <div class="support-requests-grid" id="supportRequestsList">
                <div class="empty-state">
                    <i class="bi bi-headset"></i>
                    <h3>Загрузка запросов поддержки...</h3>
                </div>
            </div>

            <!-- Пагинация -->
            <div class="pagination" id="pagination" style="display: none;">
                
            </div>
        </div>

        <footer class="dashboard-footer">
            <p>© 2024 Support System. Управление поддержкой</p>
        </footer>
    </div>

    <!-- Модальное окно просмотра запроса -->
    <div class="modal" id="viewRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewRequestTitle"></h2>
                <button onclick="closeModal('viewRequestModal')" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="viewRequestContent"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('viewRequestModal')" class="btn-cancel">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования запроса -->
    <div class="modal" id="editRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Редактирование запроса</h2>
                <button onclick="closeModal('editRequestModal')" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editRequestForm" class="edit-form">
                    <div class="form-group">
                        <label>Тема:</label>
                        <input type="text" id="editRequestTopic" required maxlength="250">
                    </div>
                    <div class="form-group">
                        <label>Сообщение:</label>
                        <textarea id="editRequestMessage" required maxlength="3500"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Статус:</label>
                        <select id="editRequestStatus">
                            <option value="New">Новый</option>
                            <option value="Processing">В обработке</option>
                            <option value="Completed">Завершен</option>
                            <option value="Cancelled">Отменен</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('editRequestModal')" class="btn-cancel">Отмена</button>
                <button onclick="saveEditedRequest()" class="btn-save" id="saveEditBtn">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно ответа на запрос -->
    <div class="modal" id="respondRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ответ на запрос</h2>
                <button onclick="closeModal('respondRequestModal')" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="respondRequestInfo" style="margin-bottom: 20px;"></div>
                <form id="respondRequestForm" class="edit-form">
                    <div class="form-group">
                        <label>Заголовок ответа:</label>
                        <input type="text" id="respondTitle" required maxlength="250">
                    </div>
                    <div class="form-group">
                        <label>Содержание ответа:</label>
                        <textarea id="respondContent" required maxlength="3500"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="completeRequestCheckbox">
                            Завершить запрос после отправки ответа
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('respondRequestModal')" class="btn-cancel">Отмена</button>
                <button onclick="submitResponse()" class="btn-save" id="submitResponseBtn">Отправить ответ</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно удаления -->
    <div class="modal" id="deleteRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Удаление запроса</h2>
                <button onclick="closeModal('deleteRequestModal')" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteRequestMessage">Вы уверены, что хотите удалить этот запрос поддержки?</p>
                <p style="color: #f44336; font-weight: bold; margin-top: 10px;">
                    <i class="bi bi-exclamation-triangle"></i> Внимание! Все связанные отчеты также будут удалены!
                </p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('deleteRequestModal')" class="btn-cancel">Отмена</button>
                <button onclick="confirmDeleteRequest()" class="btn-delete" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://localhost:7100';
        let currentUser = null;
        let allSupportRequests = [];
        let filteredSupportRequests = [];
        let managers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentEditingRequestId = null;
        let currentDeletingRequestId = null;

        document.addEventListener('DOMContentLoaded', function () {
            initializeSupportManagement();
        });

        async function initializeSupportManagement() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await loadAllData();
                await loadManagers();
                renderStats();
                applyFilters();
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            if (!token || !userJson) {
                showNotification('Требуется авторизация', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }

            try {
                currentUser = JSON.parse(userJson);
                document.getElementById('userName').textContent = currentUser.name;

                // Проверяем, что пользователь имеет роль Admin или Manager
                if (currentUser.role !== 'Admin' && currentUser.role !== 'Manager') {
                    redirectByRole(currentUser.role);
                    return false;
                }

                const response = await fetch(`${API_URL}/api/Auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.clear();
                    showNotification('Сессия истекла', 'error');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.clear();
                showNotification('Ошибка авторизации', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }
        }

        async function loadAllData() {
            try {
                await loadSupportRequests();
                renderStats();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Ошибка загрузки данных', 'error');
            }
        }

        async function loadManagers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Users/managers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    managers = await response.json();
                    populateManagerFilter();
                }
            } catch (error) {
                console.error('Error loading managers:', error);
            }
        }

        async function loadSupportRequests() {
            try {
                const token = localStorage.getItem('token');
                const endpoint = currentUser.role === 'Admin'
                    ? `${API_URL}/api/SupportRequests/manager`
                    : `${API_URL}/api/SupportRequests`;

                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    allSupportRequests = await response.json();
                    return allSupportRequests;
                } else {
                    console.error('Failed to load support requests:', response.status);
                    showNotification('Ошибка загрузки запросов поддержки', 'error');
                    return [];
                }
            } catch (error) {
                console.error('Error loading support requests:', error);
                showNotification('Ошибка загрузки запросов поддержки', 'error');
                return [];
            }
        }

        function populateManagerFilter() {
            const filterManager = document.getElementById('filterManager');
            if (!filterManager) return;

            // Очищаем существующие опции (кроме первой)
            while (filterManager.options.length > 1) {
                filterManager.remove(1);
            }

            // Добавляем менеджеров
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager.id;
                option.textContent = `${manager.name} (${manager.email})`;
                filterManager.appendChild(option);
            });
        }

        function renderStats() {
            const stats = calculateStats();
            const statsContainer = document.getElementById('supportStats');

            const statsHtml = `
                    <div class="stat-card new" onclick="filterByStatus('New')">
                        <div class="stat-number">${stats.new}</div>
                        <div class="stat-label">Новые</div>
                    </div>
                    <div class="stat-card processing" onclick="filterByStatus('Processing')">
                        <div class="stat-number">${stats.processing}</div>
                        <div class="stat-label">В обработке</div>
                    </div>
                    <div class="stat-card completed" onclick="filterByStatus('Completed')">
                        <div class="stat-number">${stats.completed}</div>
                        <div class="stat-label">Завершенные</div>
                    </div>
                    <div class="stat-card cancelled" onclick="filterByStatus('Cancelled')">
                        <div class="stat-number">${stats.cancelled}</div>
                        <div class="stat-label">Отмененные</div>
                    </div>
                `;

            statsContainer.innerHTML = statsHtml;
        }

        function calculateStats() {
            const stats = {
                new: 0,
                processing: 0,
                completed: 0,
                cancelled: 0,
                total: allSupportRequests.length
            };

            allSupportRequests.forEach(request => {
                const status = normalizeProperty(request, 'status');
                switch (status) {
                    case 'New': stats.new++; break;
                    case 'Processing': stats.processing++; break;
                    case 'Completed': stats.completed++; break;
                    case 'Cancelled': stats.cancelled++; break;
                }
            });

            return stats;
        }

        function filterByStatus(status) {
            document.getElementById('filterStatus').value = status;
            applyFilters();
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const managerFilter = document.getElementById('filterManager').value;
            const clientFilter = document.getElementById('filterClient').value.toLowerCase().trim();

            filteredSupportRequests = allSupportRequests.filter(request => {
                // Фильтр по статусу
                const status = normalizeProperty(request, 'status');
                if (statusFilter && status !== statusFilter) {
                    return false;
                }

                // Фильтр по менеджеру
                const assignedToId = normalizeProperty(request, 'assignedToId');
                if (managerFilter && assignedToId != managerFilter) {
                    return false;
                }

                // Фильтр по клиенту
                const clientName = normalizeProperty(request, 'clientName', '').toLowerCase();
                if (clientFilter && !clientName.includes(clientFilter)) {
                    return false;
                }

                return true;
            });

            currentPage = 1;
            renderSupportRequests();
            renderPagination();
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterManager').value = '';
            document.getElementById('filterClient').value = '';
            applyFilters();
        }

        function renderSupportRequests() {
            const container = document.getElementById('supportRequestsList');

            if (filteredSupportRequests.length === 0) {
                container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-search"></i>
                            <h3>Запросы не найдены</h3>
                            <p>Попробуйте изменить параметры фильтра</p>
                        </div>
                    `;
                return;
            }

            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentRequests = filteredSupportRequests.slice(startIndex, endIndex);

            let html = '';
            currentRequests.forEach(request => {
                const id = normalizeProperty(request, 'id');
                const topic = normalizeProperty(request, 'topic');
                const message = normalizeProperty(request, 'message');
                const status = normalizeProperty(request, 'status');
                const createDate = new Date(normalizeProperty(request, 'createDate'));
                const clientName = normalizeProperty(request, 'clientName');
                const clientEmail = normalizeProperty(request, 'clientEmail');
                const managerName = normalizeProperty(request, 'managerName');
                const relatedOrderId = normalizeProperty(request, 'relatedOrderId');
                const orderName = normalizeProperty(request, 'orderName');
                const reportCount = normalizeProperty(request, 'reportCount', 0);

                // Определяем класс статуса
                let statusClass = '';
                switch (status) {
                    case 'New': statusClass = 'status-new'; break;
                    case 'Processing': statusClass = 'status-processing'; break;
                    case 'Completed': statusClass = 'status-completed'; break;
                    case 'Cancelled': statusClass = 'status-cancelled'; break;
                }

                
                const formattedDate = createDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                   
                });

                
                const shortMessage = message.length > 200
                    ? message.substring(0, 200) + '...'
                    : message;

                html += `
                        <div class="support-request-card ${status.toLowerCase()}">
                            <div class="request-header">
                                <div>
                                    <div class="request-title">${escapeHtml(topic)}</div>
                                    <div class="request-meta">
                                        <span class="request-client">${escapeHtml(clientName)}</span>
                                        <span class="request-status ${statusClass}">${getStatusText(status)}</span>
                                        <span>${formattedDate}</span>
                                        ${managerName ? `<span><i class="bi bi-person"></i> ${escapeHtml(managerName)}</span>` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="request-content">${escapeHtml(shortMessage)}</div>

                            ${relatedOrderId ? `
                            <div style="margin-bottom: 10px;">
                                <small style="color: #666;">
                                    <i class="bi bi-link"></i> Связанный заказ:
                                    ${orderName ? `${escapeHtml(orderName)} (ID: ${relatedOrderId})` : `ID: ${relatedOrderId}`}
                                </small>
                            </div>
                            ` : ''}

                            <div class="request-actions">
                                <button onclick="viewRequestDetail(${id})" class="btn-view">
                                    <i class="bi bi-eye"></i> Просмотр
                                </button>
                                <button onclick="editRequest(${id})" class="btn-edit">
                                    <i class="bi bi-pencil"></i> Редактировать
                                </button>
                                ${status !== 'Completed' && status !== 'Cancelled' ? `
                                <button onclick="respondToRequest(${id})" class="btn-respond">
                                    <i class="bi bi-reply"></i> Ответить
                                </button>
                                ` : ''}
                                ${currentUser.role === 'Admin' ? `
                                <button onclick="deleteRequest(${id})" class="btn-delete">
                                    <i class="bi bi-trash"></i> Удалить
                                </button>
                                ` : ''}
                            </div>

                            <!-- Ответы -->
                            <div class="reports-section">
                                <div class="reports-title">
                                    <i class="bi bi-chat-dots"></i> Ответы (${reportCount})
                                </div>
                                <div id="reports-${id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    `;
            });

            container.innerHTML = html;

            
            currentRequests.forEach(request => {
                const id = normalizeProperty(request, 'id');
                loadReports(id);
            });
        }

        
        function normalizeProperty(obj, propertyName, defaultValue = '') {
            if (!obj) return defaultValue;

            
            if (obj[propertyName] !== undefined) return obj[propertyName];
            if (obj[propertyName.charAt(0).toUpperCase() + propertyName.slice(1)] !== undefined)
                return obj[propertyName.charAt(0).toUpperCase() + propertyName.slice(1)];

            return defaultValue;
        }

        async function loadReports(requestId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Reports/support-request/${requestId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const reports = await response.json();
                    displayReports(requestId, reports);
                } else {
                    displayReports(requestId, []);
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                displayReports(requestId, []);
            }
        }

        function displayReports(requestId, reports) {
            const container = document.getElementById(`reports-${requestId}`);
            if (!container) return;

            if (!reports || reports.length === 0) {
                container.innerHTML = '<div class="no-reports">Ответов пока нет</div>';
                return;
            }

            let html = '';
            reports.forEach(report => {
                const createDate = new Date(report.CreateDate || report.createDate || new Date());
                const formattedDate = createDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                    
                });

                html += `
                        <div class="report-item">
                            <div class="report-header">
                                <span class="report-author">${escapeHtml(report.AuthorName || report.authorName || 'Неизвестный автор')}</span>
                                <span class="report-date">${formattedDate}</span>
                            </div>
                            <div class="report-content">
                                <strong>${escapeHtml(report.Title || report.title)}:</strong>
                                <p>${escapeHtml(report.Content || report.content)}</p>
                            </div>
                        </div>
                    `;
            });

            container.innerHTML = html;
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredSupportRequests.length / itemsPerPage);
            const container = document.getElementById('pagination');

            if (totalPages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';

            let html = '';

            
            html += `
                    <button onclick="changePage(${currentPage - 1})"
                            class="page-btn ${currentPage === 1 ? 'disabled' : ''}"
                            ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="bi bi-chevron-left"></i>
                    </button>
                `;

            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `
                            <button onclick="changePage(${i})"
                                    class="page-btn ${i === currentPage ? 'active' : ''}">
                                ${i}
                            </button>
                        `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span class="page-btn disabled">...</span>`;
                }
            }

            
            html += `
                    <button onclick="changePage(${currentPage + 1})"
                            class="page-btn ${currentPage === totalPages ? 'disabled' : ''}"
                            ${currentPage === totalPages ? 'disabled' : ''}>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                `;

            container.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredSupportRequests.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderSupportRequests();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function viewRequestDetail(id) {
            try {
                const token = localStorage.getItem('token');

                // Пробуем несколько эндпоинтов по очереди
                const endpoints = [
                    `${API_URL}/api/SupportRequests/manager/detail/${id}`,
                    `${API_URL}/api/SupportRequests/simple-detail/${id}`,
                    `${API_URL}/api/SupportRequests/${id}`
                ];

                let response = null;
                let result = null;

                for (const endpoint of endpoints) {
                    try {
                        response = await fetch(endpoint, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            result = await response.json();
                            break;
                        }
                    } catch (error) {
                        console.warn(`Endpoint ${endpoint} failed:`, error);
                        continue;
                    }
                }

                if (response && response.ok && result) {
                    displayRequestModal(result);
                } else {
                    // Если ни один endpoint не сработал, пробуем получить базовую информацию
                    const request = allSupportRequests.find(r => normalizeProperty(r, 'id') === id);
                    if (request) {
                        displaySimpleRequestModal(request);
                    } else {
                        showNotification('Не удалось загрузить детали запроса', 'error');
                    }
                }
            } catch (error) {
                console.error('Error viewing request detail:', error);
                showNotification('Ошибка загрузки деталей запроса', 'error');
            }
        }

        function displayRequestModal(data) {
            const modal = document.getElementById('viewRequestModal');
            const title = document.getElementById('viewRequestTitle');
            const content = document.getElementById('viewRequestContent');

            
            let request = data;
            if (data.supportRequest) {
                request = data.supportRequest;
            } else if (data.data) {
                request = data.data;
            }

            const createDate = new Date(request.CreateDate || request.createDate || new Date());
            const formattedDate = createDate.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
               
            });

            const statusText = getStatusText(request.Status || request.status);

            let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 10px;">${escapeHtml(request.Topic || request.topic || 'Без темы')}</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="line-height: 1.6; color: #333;">${escapeHtml(request.Message || request.message || 'Нет сообщения')}</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>Статус:</strong>
                            <div style="display: inline-block; margin-left: 10px; padding: 4px 12px; border-radius: 12px;
                                 background: ${getStatusColor(request.Status || request.status)}; color: white;">
                                ${statusText}
                            </div>
                        </div>
                        <div>
                            <strong>Дата создания:</strong>
                            <div>${formattedDate}</div>
                        </div>
                    </div>
                `;

            // Клиент
            if (request.Client) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Клиент</h4>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                                <p><strong>Имя:</strong> ${escapeHtml(request.Client.Name || request.Client.name || 'Не указано')}</p>
                                <p><strong>Email:</strong> ${escapeHtml(request.Client.Email || request.Client.email || 'Не указано')}</p>
                                <p><strong>Телефон:</strong> ${escapeHtml(request.Client.Phone || request.Client.phone || 'Не указано')}</p>
                            </div>
                        </div>
                    `;
            } else if (request.clientName || request.ClientName) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Клиент</h4>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                                <p><strong>Имя:</strong> ${escapeHtml(request.clientName || request.ClientName || 'Не указано')}</p>
                                <p><strong>Email:</strong> ${escapeHtml(request.clientEmail || request.ClientEmail || 'Не указано')}</p>
                                <p><strong>Телефон:</strong> ${escapeHtml(request.clientPhone || request.ClientPhone || 'Не указано')}</p>
                            </div>
                        </div>
                    `;
            }

            // Менеджер
            if (request.Manager) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Ответственный менеджер</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                                <p><strong>Имя:</strong> ${escapeHtml(request.Manager.Name || request.Manager.name || 'Не указано')}</p>
                                <p><strong>Email:</strong> ${escapeHtml(request.Manager.Email || request.Manager.email || 'Не указано')}</p>
                                <p><strong>Телефон:</strong> ${escapeHtml(request.Manager.Phone || request.Manager.phone || 'Не указано')}</p>
                            </div>
                        </div>
                    `;
            } else if (request.managerName || request.ManagerName) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Ответственный менеджер</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                                <p><strong>Имя:</strong> ${escapeHtml(request.managerName || request.ManagerName || 'Не указано')}</p>
                                ${request.managerEmail || request.ManagerEmail ? `<p><strong>Email:</strong> ${escapeHtml(request.managerEmail || request.ManagerEmail)}</p>` : ''}
                            </div>
                        </div>
                    `;
            }

            // Связанный заказ
            if (request.RelatedOrder) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Связанный заказ</h4>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <p><strong>Название:</strong> ${escapeHtml(request.RelatedOrder.OrderName || request.RelatedOrder.orderName || 'Не указано')}</p>
                                <p><strong>Статус:</strong> ${getOrderStatusText(request.RelatedOrder.Status || request.RelatedOrder.status)}</p>
                            </div>
                        </div>
                    `;
            } else if (request.relatedOrderId || request.RelatedOrderId) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Связанный заказ</h4>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <p><strong>ID заказа:</strong> ${request.relatedOrderId || request.RelatedOrderId}</p>
                                ${request.orderName || request.OrderName ? `<p><strong>Название:</strong> ${escapeHtml(request.orderName || request.OrderName)}</p>` : ''}
                            </div>
                        </div>
                    `;
            }

            // Ответы/отчеты
            const reports = request.Reports || request.reports || [];
            if (reports.length > 0) {
                html += `
                        <div style="margin-top: 30px;">
                            <h4 style="color: #666; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                <i class="bi bi-chat-dots"></i> Ответы (${reports.length})
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                    `;

                reports.forEach(report => {
                    const reportData = report;
                    const reportDate = new Date(reportData.CreateDate || reportData.createDate || new Date());
                    const formattedReportDate = reportDate.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                       
                    });

                    html += `
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #4CAF50;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <strong>${escapeHtml(reportData.Title || reportData.title || 'Без заголовка')}</strong>
                                    <small style="color: #666;">${formattedReportDate}</small>
                                </div>
                                <p style="color: #333; line-height: 1.5;">${escapeHtml(reportData.Content || reportData.content || 'Нет содержания')}</p>
                                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                    <i class="bi bi-person"></i> ${escapeHtml(reportData.Author?.Name || reportData.AuthorName || reportData.authorName || 'Неизвестный автор')}
                                </div>
                            </div>
                        `;
                });

                html += `
                            </div>
                        </div>
                    `;
            }

            title.textContent = escapeHtml(request.Topic || request.topic || 'Запрос поддержки');
            content.innerHTML = html;
            modal.classList.add('active');
        }

        function displaySimpleRequestModal(request) {
            const modal = document.getElementById('viewRequestModal');
            const title = document.getElementById('viewRequestTitle');
            const content = document.getElementById('viewRequestContent');

            const id = normalizeProperty(request, 'id');
            const topic = normalizeProperty(request, 'topic');
            const message = normalizeProperty(request, 'message');
            const status = normalizeProperty(request, 'status');
            const createDate = new Date(normalizeProperty(request, 'createDate', new Date()));
            const clientName = normalizeProperty(request, 'clientName');
            const clientEmail = normalizeProperty(request, 'clientEmail');
            const managerName = normalizeProperty(request, 'managerName');
            const relatedOrderId = normalizeProperty(request, 'relatedOrderId');
            const orderName = normalizeProperty(request, 'orderName');

            const formattedDate = createDate.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
               
            });

            const statusText = getStatusText(status);

            let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 10px;">${escapeHtml(topic)}</h3>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="line-height: 1.6; color: #333;">${escapeHtml(message)}</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>Статус:</strong>
                            <div style="display: inline-block; margin-left: 10px; padding: 4px 12px; border-radius: 12px;
                                 background: ${getStatusColor(status)}; color: white;">
                                ${statusText}
                            </div>
                        </div>
                        <div>
                            <strong>Дата создания:</strong>
                            <div>${formattedDate}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #666; margin-bottom: 10px;">Клиент</h4>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <p><strong>Имя:</strong> ${escapeHtml(clientName)}</p>
                            ${clientEmail ? `<p><strong>Email:</strong> ${escapeHtml(clientEmail)}</p>` : ''}
                        </div>
                    </div>
                `;

            if (managerName) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Ответственный менеджер</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                                <p><strong>Имя:</strong> ${escapeHtml(managerName)}</p>
                            </div>
                        </div>
                    `;
            }

            if (relatedOrderId) {
                html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #666; margin-bottom: 10px;">Связанный заказ</h4>
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <p><strong>ID заказа:</strong> ${relatedOrderId}</p>
                                ${orderName ? `<p><strong>Название:</strong> ${escapeHtml(orderName)}</p>` : ''}
                            </div>
                        </div>
                    `;
            }

            // Загружаем отчеты отдельно
            html += `
                    <div style="margin-top: 30px;">
                        <h4 style="color: #666; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <i class="bi bi-chat-dots"></i> Ответы
                        </h4>
                        <div id="modal-reports-${id}" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px;">
                                <div class="loading-spinner"></div>
                                <p style="color: #666; margin-top: 10px;">Загрузка ответов...</p>
                            </div>
                        </div>
                    </div>
                `;

            title.textContent = escapeHtml(topic);
            content.innerHTML = html;
            modal.classList.add('active');

            // Загружаем отчеты для этого запроса
            loadReportsForModal(id);
        }

        async function loadReportsForModal(requestId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Reports/support-request/${requestId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const container = document.getElementById(`modal-reports-${requestId}`);
                if (!container) return;

                if (response.ok) {
                    const reports = await response.json();

                    if (!reports || reports.length === 0) {
                        container.innerHTML = '<div class="no-reports" style="text-align: center; padding: 20px; color: #666;">Ответов пока нет</div>';
                        return;
                    }

                    let html = '';
                    reports.forEach(report => {
                        const createDate = new Date(report.CreateDate || report.createDate || new Date());
                        const formattedDate = createDate.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                         
                        });

                        html += `
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #4CAF50;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <strong>${escapeHtml(report.Title || report.title || 'Без заголовка')}</strong>
                                        <small style="color: #666;">${formattedDate}</small>
                                    </div>
                                    <p style="color: #333; line-height: 1.5;">${escapeHtml(report.Content || report.content || 'Нет содержания')}</p>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <i class="bi bi-person"></i> ${escapeHtml(report.AuthorName || report.authorName || 'Неизвестный автор')}
                                    </div>
                                </div>
                            `;
                    });

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-reports" style="text-align: center; padding: 20px; color: #666;">Не удалось загрузить ответы</div>';
                }
            } catch (error) {
                console.error('Error loading reports for modal:', error);
                const container = document.getElementById(`modal-reports-${requestId}`);
                if (container) {
                    container.innerHTML = '<div class="no-reports" style="text-align: center; padding: 20px; color: #666;">Ошибка загрузки ответов</div>';
                }
            }
        }

        function editRequest(id) {
            const request = allSupportRequests.find(r => normalizeProperty(r, 'id') === id);
            if (!request) return;

            currentEditingRequestId = id;

            // Заполняем форму редактирования
            document.getElementById('editRequestTopic').value = normalizeProperty(request, 'topic');
            document.getElementById('editRequestMessage').value = normalizeProperty(request, 'message');
            document.getElementById('editRequestStatus').value = normalizeProperty(request, 'status', 'New');

            // Открываем модальное окно
            const modal = document.getElementById('editRequestModal');
            modal.classList.add('active');
        }

        async function saveEditedRequest() {
            if (!currentEditingRequestId) return;

            const topic = document.getElementById('editRequestTopic').value.trim();
            const message = document.getElementById('editRequestMessage').value.trim();
            const status = document.getElementById('editRequestStatus').value;

            // Валидация
            if (!topic || !message) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            if (topic.length > 250) {
                showNotification('Тема не должна превышать 250 символов', 'error');
                return;
            }

            if (message.length > 3500) {
                showNotification('Сообщение не должно превышать 3500 символов', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveEditBtn');
            saveBtn.innerHTML = '<span class="loading-spinner"></span> Сохранение...';
            saveBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/SupportRequests/manager/${currentEditingRequestId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        topic: topic,
                        message: message,
                        status: status
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('Запрос успешно обновлен', 'success');
                    closeModal('editRequestModal');
                    await refreshData();
                } else {
                    showNotification(result.message || 'Ошибка обновления запроса', 'error');
                }
            } catch (error) {
                console.error('Error saving edited request:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            } finally {
                saveBtn.innerHTML = 'Сохранить';
                saveBtn.disabled = false;
            }
        }

        function respondToRequest(id) {
            const request = allSupportRequests.find(r => normalizeProperty(r, 'id') === id);
            if (!request) return;

            currentEditingRequestId = id;

            // Заполняем информацию о запросе
            const infoDiv = document.getElementById('respondRequestInfo');
            infoDiv.innerHTML = `
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p><strong>Тема:</strong> ${escapeHtml(normalizeProperty(request, 'topic'))}</p>
                        <p><strong>Клиент:</strong> ${escapeHtml(normalizeProperty(request, 'clientName'))}</p>
                    </div>
                `;

            // Сбрасываем форму
            document.getElementById('respondTitle').value = '';
            document.getElementById('respondContent').value = '';
            document.getElementById('completeRequestCheckbox').checked = false;

            // Открываем модальное окно
            const modal = document.getElementById('respondRequestModal');
            modal.classList.add('active');
        }

        async function submitResponse() {
            if (!currentEditingRequestId) return;

            const title = document.getElementById('respondTitle').value.trim();
            const content = document.getElementById('respondContent').value.trim();
            const completeRequest = document.getElementById('completeRequestCheckbox').checked;

            // Валидация
            if (!title || !content) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            if (title.length > 250) {
                showNotification('Заголовок не должен превышать 250 символов', 'error');
                return;
            }

            if (content.length > 3500) {
                showNotification('Содержание не должно превышать 3500 символов', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitResponseBtn');
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Отправка...';
            submitBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/SupportRequests/manager/respond/${currentEditingRequestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        completeRequest: completeRequest
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('Ответ успешно отправлен', 'success');
                    closeModal('respondRequestModal');
                    await refreshData();
                } else {
                    showNotification(result.message || 'Ошибка отправки ответа', 'error');
                }
            } catch (error) {
                console.error('Error submitting response:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            } finally {
                submitBtn.innerHTML = 'Отправить ответ';
                submitBtn.disabled = false;
            }
        }

        function deleteRequest(id) {
            const request = allSupportRequests.find(r => normalizeProperty(r, 'id') === id);
            if (!request) return;

            currentDeletingRequestId = id;

            // Заполняем сообщение об удалении
            const messageDiv = document.getElementById('deleteRequestMessage');
            messageDiv.innerHTML = `
                    Вы уверены, что хотите удалить запрос поддержки?<br>
                    <strong>${escapeHtml(normalizeProperty(request, 'topic'))}</strong><br>
                    <small>От: ${escapeHtml(normalizeProperty(request, 'clientName'))}</small>
                    <p style="color: #f44336; font-weight: bold; margin-top: 10px;">
                        <i class="bi bi-exclamation-triangle"></i> Внимание! Все связанные отчеты также будут удалены!
                    </p>
                `;

            // Открываем модальное окно
            const modal = document.getElementById('deleteRequestModal');
            modal.classList.add('active');
        }

        async function confirmDeleteRequest() {
            if (!currentDeletingRequestId) return;

            const deleteBtn = document.getElementById('confirmDeleteBtn');
            deleteBtn.innerHTML = '<span class="loading-spinner"></span> Удаление...';
            deleteBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');

                const response = await fetch(`${API_URL}/api/SupportRequests/${currentDeletingRequestId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Получаем данные ответа
                const result = await response.json();

                if (response.ok) {
                    if (result.success) {
                        showNotification(result.message || 'Запрос и связанные отчеты успешно удалены', 'success');
                    } else {
                        showNotification(result.message || 'Ошибка удаления запроса', 'error');
                    }
                } else {
                    
                    if (result && result.message) {
                        showNotification(result.message, 'error');
                    } else {
                        showNotification(`Ошибка ${response.status}: ${response.statusText}`, 'error');
                    }
                }

                if (response.ok && result.success) {
                    closeModal('deleteRequestModal');
                    await refreshData();
                }
            } catch (error) {
                console.error('Error deleting request:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            } finally {
                deleteBtn.innerHTML = 'Удалить';
                deleteBtn.disabled = false;
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');

            // Сбрасываем текущие ID
            if (modalId === 'editRequestModal' || modalId === 'respondRequestModal') {
                currentEditingRequestId = null;
            }
            if (modalId === 'deleteRequestModal') {
                currentDeletingRequestId = null;
            }
        }

        async function refreshData() {
            await loadSupportRequests();
            renderStats();
            applyFilters();
            showNotification('Данные обновлены', 'success');
        }

        function goToDashboard() {
            window.location.href = currentUser.role === 'Admin'
                ? 'admin-dashboard.html'
                : 'manager-dashboard.html';
        }

        function getStatusText(status) {
            const statusMap = {
                'New': 'Новый',
                'Processing': 'В обработке',
                'Completed': 'Завершен',
                'Cancelled': 'Отменен'
            };
            return statusMap[status] || status;
        }
        function getOrderStatusText(status) {
            const statusMap = {
                'New': 'Новый',
                'Processing': 'В обработке',
                'Completed': 'Завершен',
                'Cancelled': 'Отменен'
            };
            return statusMap[status] || status;
        }

        function getStatusColor(status) {
            const colorMap = {
                'New': '#ff9800',
                'Processing': '#2196F3',
                'Completed': '#4CAF50',
                'Cancelled': '#f44336'
            };
            return colorMap[status] || '#666';
        }

        function showNotification(message, type = 'info') {
            // Создаем или находим уведомление
            let notification = document.querySelector('.global-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'global-notification';
                document.body.appendChild(notification);
            }

            notification.textContent = message;
            notification.className = `global-notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, type === 'error' ? 5000 : 3000);
        }

        function redirectByRole(role) {
            const dashboards = {
                'Admin': 'admin-dashboard.html',
                'Manager': 'manager-dashboard.html',
                'User': 'user-dashboard.html'
            };
            window.location.href = dashboards[role] || 'login.html';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.logout = function () {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        };

        // Добавляем CSS для глобальных уведомлений
        const style = document.createElement('style');
        style.textContent = `
            .global-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                display: none;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            .global-notification.success {
                background: #4CAF50;
            }
            .global-notification.error {
                background: #f44336;
            }
            .global-notification.info {
                background: #2196F3;
            }
            .global-notification.warning {
                background: #ff9800;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.active');
                modals.forEach(modal => {
                    const modalId = modal.id;
                    closeModal(modalId);
                });
            }
        });

        // Закрытие модальных окон по клику на фон
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                closeModal(modalId);
            }
        });

       
        async function checkEndpoints() {
            try {
                const token = localStorage.getItem('token');

                // Проверяем доступность эндпоинтов
                const testEndpoints = [
                    `${API_URL}/api/SupportRequests/manager/detail/1`,
                    `${API_URL}/api/SupportRequests/1`
                ];

                let availableEndpoints = [];

                for (const endpoint of testEndpoints) {
                    try {
                        const response = await fetch(endpoint, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.status !== 404 && response.status !== 405) {
                            availableEndpoints.push(endpoint.split('/').slice(-2, -1)[0]);
                        }
                    } catch (error) {
                        console.warn(`Endpoint ${endpoint} not available:`, error);
                    }
                }

                console.log('Available endpoints:', availableEndpoints);
                return availableEndpoints;
            } catch (error) {
                console.error('Error checking endpoints:', error);
                return ['manager/detail', '']; 
            }
        }

        /
        setTimeout(async () => {
            const endpoints = await checkEndpoints();
            console.log('Support management initialized with endpoints:', endpoints);
        }, 1000);
    </script>
</body >
</html >
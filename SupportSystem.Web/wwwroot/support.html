<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Поддержка - Название</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/support.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="dashboard-page">
    <div class="container">
        <header class="dashboard-header">
            <h1 class="dashboard-title">
                <a href="user-dashboard.html" style="color: #667eea; text-decoration: none;">
                    <i class="bi bi-life-preserver"></i> Название
                </a>
            </h1>
            <div class="user-info">
                <span id="userName">Загрузка...</span>
                <button onclick="logout()" class="btn-logout">
                    <i class="bi bi-box-arrow-right"></i> Выйти
                </button>
            </div>
        </header>

        <div class="dashboard-content">
            <div class="page-header">
                <h1>
                    <i class="bi bi-headset"></i>
                    Техническая поддержка
                </h1>
                <p class="page-subtitle">
                    Задайте вопрос, сообщите о проблеме или обратитесь за помощью.
                    Мы ответим вам в течение 1-2 рабочих дней.
                </p>
            </div>

            <!-- Две колонки: форма создания и история запросов -->
            <div class="support-container">
                
                <div class="form-container">
                    <div class="form-section">
                        <h3>
                            <i class="bi bi-plus-circle"></i>
                            Новый запрос в поддержку
                        </h3>

                        <div class="form-group">
                            <label class="form-label">
                                Тема запроса
                                <span class="required-star">*</span>
                            </label>
                            <input type="text" id="topic" class="form-input"
                                   placeholder="Опишите кратко вашу проблему или вопрос"
                                   maxlength="250">
                            <div class="char-counter" id="topicCounter">0/250 символов</div>
                            <div class="error-text" id="topicError"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Связать с заказом (необязательно)
                            </label>
                            <select id="relatedOrderId" class="form-input orders-select">
                                <option value="">-- Не привязывать к заказу --</option>
                               
                            </select>
                            <div class="form-hint">
                                Выберите заказ, если ваш запрос связан с ним
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                Подробное описание
                                <span class="required-star">*</span>
                            </label>
                            <textarea id="message" class="form-input message-textarea"
                                      rows="6"
                                      placeholder="Опишите вашу проблему или вопрос максимально подробно...

Например:
1. Какая именно проблема возникла?
2. Когда она произошла?
3. Какие действия вы уже предприняли?
4. Что вы ожидаете в результате?"
                                      maxlength="3500"></textarea>
                            <div class="char-counter" id="messageCounter">0/3500 символов</div>
                            <div class="error-text" id="messageError"></div>
                        </div>

                        <div class="form-actions">
                            <button onclick="createSupportRequest()" class="btn-primary" id="createBtn">
                                <i class="bi bi-send-fill"></i>
                                Отправить запрос
                            </button>
                            <button onclick="goBack()" class="btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Назад
                            </button>
                        </div>
                    </div>

                    <div class="form-info-card">
                        <h4><i class="bi bi-lightbulb"></i> Советы для быстрого решения</h4>
                        <ul>
                            <li>Укажите номер заказа, если проблема связана с конкретным заказом</li>
                            <li>Приложите скриншоты, если это поможет понять проблему</li>
                            <li>Опишите последовательность действий, которые привели к проблеме</li>
                            <li>Укажите дату и время возникновения проблемы</li>
                            <li>По срочным вопросам звоните: 8-800-XXX-XX-XX</li>
                        </ul>
                    </div>
                </div>

                
                <div class="form-container">
                    <div class="form-section">
                        <h3>
                            <i class="bi bi-clock-history"></i>
                            История ваших запросов
                        </h3>

                        <div id="supportRequestsList">
                            <div class="loading-requests" id="requestsLoading">
                                <div class="loading-spinner"></div>
                                <p>Загрузка ваших запросов...</p>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="bi bi-info-circle"></i> Статусы запросов</h3>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-new" style="min-width: 100px;">Новый</span>
                                <span style="color: #475569; font-size: 0.9rem;">Запрос получен, ожидает рассмотрения</span>
                            </li>
                            <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-processing" style="min-width: 100px;">В обработке</span>
                                <span style="color: #475569; font-size: 0.9rem;">Менеджер работает над решением</span>
                            </li>
                            <li style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-completed" style="min-width: 100px;">Завершен</span>
                                <span style="color: #475569; font-size: 0.9rem;">Запрос решен и закрыт</span>
                            </li>
                            <li style="display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-cancelled" style="min-width: 100px;">Отменен</span>
                                <span style="color: #475569; font-size: 0.9rem;">Запрос был отменен</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <footer class="dashboard-footer">
            <p>© 2024 Support System. Техническая поддержка клиентов</p>
        </footer>
    </div>

    <!-- Уведомление -->
    <div id="notification" class="notification" style="display: none;"></div>

    <!-- Модальное окно с деталями запроса -->
    <div id="requestModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Детали запроса</h3>
                <button onclick="closeModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
                
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://localhost:7100';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function () {
            initializePage();
        });

        async function initializePage() {
            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                await loadUserData();
                await loadOrdersForDropdown();
                await loadSupportRequests();
                setupFormListeners();
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');

            if (!token || !userJson) {
                showNotification('Требуется авторизация', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }

            try {
                currentUser = JSON.parse(userJson);

                // Проверяем, что пользователь имеет роль User
                if (currentUser.role !== 'User') {
                    redirectByRole(currentUser.role);
                    return false;
                }

                // Проверяем токен
                const response = await fetch(`${API_URL}/api/Auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.clear();
                    showNotification('Сессия истекла', 'error');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                localStorage.clear();
                showNotification('Ошибка авторизации', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return false;
            }
        }

        async function loadUserData() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/Users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('userName').textContent = userData.name || userData.email || 'Пользователь';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadOrdersForDropdown() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/SupportRequests/my-orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const orders = await response.json();
                    const select = document.getElementById('relatedOrderId');

                    // Сохраняем текущее выбранное значение
                    const currentValue = select.value;

                    
                    while (select.options.length > 1) {
                        select.remove(1);
                    }

                    // Добавляем заказы
                    if (orders && orders.length > 0) {
                        orders.forEach(order => {
                            const option = document.createElement('option');
                            option.value = order.id;

                            
                            const date = new Date(order.createDate);
                            const dateStr = date.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });

                            
                            let orderName = order.orderName;
                            if (orderName.length > 50) {
                                orderName = orderName.substring(0, 47) + '...';
                            }

                            option.textContent = `#${order.id} - ${orderName} (${order.status}, ${dateStr})`;
                            select.appendChild(option);
                        });

                        
                        if (currentValue) {
                            select.value = currentValue;
                        }
                    } else {
                        
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "У вас пока нет заказов";
                        option.disabled = true;
                        select.appendChild(option);
                    }
                }
            } catch (error) {
                console.error('Error loading orders for dropdown:', error);
            }
        }

        async function loadSupportRequests() {
            const requestsList = document.getElementById('supportRequestsList');
            const loadingElement = document.getElementById('requestsLoading');

            if (loadingElement) {
                loadingElement.style.display = 'block';
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/SupportRequests/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const requests = await response.json();
                    displaySupportRequests(requests);
                } else {
                    requestsList.innerHTML = `
                                <div class="empty-requests">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <p>Не удалось загрузить историю запросов</p>
                                    <button onclick="loadSupportRequests()" class="btn-secondary" style="margin-top: 15px;">
                                        <i class="bi bi-arrow-clockwise"></i> Повторить
                                    </button>
                                </div>
                            `;
                }
            } catch (error) {
                console.error('Error loading support requests:', error);
                requestsList.innerHTML = `
                            <div class="empty-requests">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>Ошибка загрузки истории запросов</p>
                                <button onclick="loadSupportRequests()" class="btn-secondary" style="margin-top: 15px;">
                                    <i class="bi bi-arrow-clockwise"></i> Повторить
                                </button>
                            </div>
                        `;
            } finally {
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        function displaySupportRequests(requests) {
            const requestsList = document.getElementById('supportRequestsList');

            if (!requests || requests.length === 0) {
                requestsList.innerHTML = `
                            <div class="empty-requests">
                                <i class="bi bi-inbox"></i>
                                <p>У вас пока нет запросов в поддержку</p>
                                <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 5px;">
                                    Создайте первый запрос, используя форму слева
                                </p>
                            </div>
                        `;
                return;
            }

            const requestsHtml = requests.map((request, index) => {
                const statusIcon = getStatusIcon(request.status);
                const statusColor = getStatusColor(request.status);
                const statusText = getStatusText(request.status);

                
                const date = new Date(request.createDate);
                const dateStr = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

               
                let topic = request.topic;
                if (topic.length > 60) {
                    topic = topic.substring(0, 57) + '...';
                }

                return `
                            <div class="request-item" onclick="showRequestDetails(${request.id})">
                                <div class="request-content">
                                    <div class="request-icon" style="color: ${statusColor};">
                                        <i class="bi ${statusIcon}"></i>
                                    </div>
                                    <div class="request-info">
                                        <div class="request-title">${topic}</div>
                                        <div class="request-meta">
                                            ${request.orderName ?
                        `<span class="request-order">
                                                    <i class="bi bi-box"></i> ${request.orderName}
                                                </span>`
                        : ''
                    }
                                            <span class="request-date">
                                                <i class="bi bi-calendar"></i> ${dateStr}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="request-status">
                                        <span class="status-badge status-${request.status.toLowerCase()}">
                                            ${statusText}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
            }).join('');

            requestsList.innerHTML = requestsHtml;
        }

        function getStatusIcon(status) {
            switch (status.toLowerCase()) {
                case 'new': return 'bi-plus-circle';
                case 'processing': return 'bi-gear';
                case 'completed': return 'bi-check-circle';
                case 'cancelled': return 'bi-x-circle';
                default: return 'bi-question-circle';
            }
        }

        function getStatusColor(status) {
            switch (status.toLowerCase()) {
                case 'new': return '#f59e0b';
                case 'processing': return '#3b82f6';
                case 'completed': return '#10b981';
                case 'cancelled': return '#ef4444';
                default: return '#64748b';
            }
        }

        function getStatusText(status) {
            switch (status.toLowerCase()) {
                case 'new': return 'Новый';
                case 'processing': return 'В обработке';
                case 'completed': return 'Завершен';
                case 'cancelled': return 'Отменен';
                default: return status;
            }
        }

        async function showRequestDetails(requestId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/SupportRequests/${requestId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const request = await response.json();
                    openRequestModal(request);
                } else {
                    showNotification('Не удалось загрузить детали запроса', 'error');
                }
            } catch (error) {
                console.error('Error loading request details:', error);
                showNotification('Ошибка загрузки деталей запроса', 'error');
            }
        }

        function openRequestModal(request) {
            const modal = document.getElementById('requestModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            const statusText = getStatusText(request.status);
            const statusColor = getStatusColor(request.status);

            
            const date = new Date(request.createDate);
            const dateStr = date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });

            title.textContent = `Запрос #${request.id}: ${request.topic}`;

            content.innerHTML = `
                        <div class="details-grid">
                            <div class="request-detail">
                                <div class="detail-label">Статус</div>
                                <div class="detail-value">
                                    <span class="status-badge" style="background: ${statusColor + '20'}; color: ${statusColor}; border-color: ${statusColor + '40'};">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>

                            <div class="request-detail">
                                <div class="detail-label">Дата создания</div>
                                <div class="detail-value">${dateStr}</div>
                            </div>
                        </div>

                        <div class="request-detail">
                            <div class="detail-label">Тема</div>
                            <div class="detail-value">${request.topic}</div>
                        </div>

                        <div class="request-detail">
                            <div class="detail-label">Сообщение</div>
                            <div class="detail-value message-content">${request.message}</div>
                        </div>

                        ${request.orderName ? `
                            <div class="request-detail">
                                <div class="detail-label">Связанный заказ</div>
                                <div class="detail-value">
                                    <strong>#${request.relatedOrderId}</strong> - ${request.orderName}
                                </div>
                            </div>
                        ` : ''}

                        ${request.managerName && request.managerName !== 'Не назначен' ? `
                            <div class="request-detail">
                                <div class="detail-label">Ответственный менеджер</div>
                                <div class="detail-value">
                                    <i class="bi bi-person" style="color: #667eea; margin-right: 8px;"></i>
                                    ${request.managerName}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
                            <button onclick="closeModal()" class="btn-secondary">
                                <i class="bi bi-x-lg"></i> Закрыть
                            </button>
                        </div>
                    `;

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        function setupFormListeners() {
            // Счетчики символов
            const topicInput = document.getElementById('topic');
            const messageInput = document.getElementById('message');
            const topicCounter = document.getElementById('topicCounter');
            const messageCounter = document.getElementById('messageCounter');

            const updateCounter = (input, counter, max) => {
                const length = input.value.length;
                counter.textContent = `${length}/${max} символов`;

                
                if (length > max * 0.9) {
                    counter.className = 'char-counter limit-warning';
                } else if (length > max) {
                    counter.className = 'char-counter limit-exceeded';
                } else {
                    counter.className = 'char-counter';
                }
            };

            if (topicInput && topicCounter) {
                topicInput.addEventListener('input', () => {
                    updateCounter(topicInput, topicCounter, 250);
                });
                
                updateCounter(topicInput, topicCounter, 250);
            }

            if (messageInput && messageCounter) {
                messageInput.addEventListener('input', () => {
                    updateCounter(messageInput, messageCounter, 3500);
                });
                
                updateCounter(messageInput, messageCounter, 3500);
            }
        }

        async function createSupportRequest() {
            const topic = document.getElementById('topic').value.trim();
            const message = document.getElementById('message').value.trim();
            const relatedOrderId = document.getElementById('relatedOrderId').value;
            const createBtn = document.getElementById('createBtn');

            
            clearErrors();

            // Валидация
            let isValid = true;

            if (!topic) {
                showError('topicError', 'Пожалуйста, укажите тему запроса');
                isValid = false;
            }

            if (!message) {
                showError('messageError', 'Пожалуйста, опишите вашу проблему');
                isValid = false;
            }

            if (topic.length > 250) {
                showError('topicError', 'Тема не должна превышать 250 символов');
                isValid = false;
            }

            if (message.length > 3500) {
                showError('messageError', 'Сообщение не должно превышать 3500 символов');
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // Показываем загрузку на кнопке
            createBtn.innerHTML = '<span class="loading-spinner" style="width: 20px; height: 20px; border-width: 3px;"></span> Отправка...';
            createBtn.disabled = true;

            try {
                const token = localStorage.getItem('token');
                const requestData = {
                    topic: topic,
                    message: message,
                    relatedOrderId: relatedOrderId ? parseInt(relatedOrderId) : null
                };

                const response = await fetch(`${API_URL}/api/SupportRequests/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(result.message, 'success');

                    // Очищаем форму
                    document.getElementById('topic').value = '';
                    document.getElementById('message').value = '';
                    document.getElementById('relatedOrderId').value = '';

                    // Обновляем счетчики
                    document.getElementById('topicCounter').textContent = '0/250 символов';
                    document.getElementById('messageCounter').textContent = '0/3500 символов';

                    // Обновляем список запросов
                    await loadSupportRequests();

                    // Обновляем список заказов (на случай, если создался новый заказ)
                    await loadOrdersForDropdown();
                } else {
                    showNotification(result.message || 'Ошибка при создании запроса', 'error');
                }
            } catch (error) {
                console.error('Error creating support request:', error);
                showNotification('Ошибка соединения с сервером', 'error');
            } finally {
                // Восстанавливаем кнопку
                createBtn.innerHTML = '<i class="bi bi-send-fill"></i> Отправить запрос';
                createBtn.disabled = false;
            }
        }

        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-text');
            errorElements.forEach(element => {
                element.style.display = 'none';
                element.textContent = '';
            });
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;

            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            // Автоматическое скрытие
            const hideTimeout = setTimeout(() => {
                notification.style.display = 'none';
            }, type === 'error' ? 5000 : 3000);

            
            notification.onclick = () => {
                clearTimeout(hideTimeout);
                notification.style.display = 'none';
            };
        }

        function redirectByRole(role) {
            const dashboards = {
                'Admin': 'admin-dashboard.html',
                'Manager': 'manager-dashboard.html',
                'User': 'user-dashboard.html'
            };
            window.location.href = dashboards[role] || 'login.html';
        }

        window.logout = function () {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        };

        window.goBack = function () {
            window.history.back();
        };

        
        window.onclick = function (event) {
            const modal = document.getElementById('requestModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>